<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>cms.menu &mdash; obp 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="obp 0.0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">obp 0.0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for cms.menu</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">cms.apphook_pool</span> <span class="kn">import</span> <span class="n">apphook_pool</span>
<span class="kn">from</span> <span class="nn">cms.models.moderatormodels</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ACCESS_DESCENDANTS</span><span class="p">,</span> 
    <span class="n">ACCESS_PAGE_AND_DESCENDANTS</span><span class="p">,</span> <span class="n">ACCESS_CHILDREN</span><span class="p">,</span> <span class="n">ACCESS_PAGE_AND_CHILDREN</span><span class="p">,</span> <span class="n">ACCESS_PAGE</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">cms.models.permissionmodels</span> <span class="kn">import</span> <span class="n">PagePermission</span><span class="p">,</span> <span class="n">GlobalPagePermission</span>
<span class="kn">from</span> <span class="nn">cms.models.titlemodels</span> <span class="kn">import</span> <span class="n">Title</span>
<span class="kn">from</span> <span class="nn">cms.utils</span> <span class="kn">import</span> <span class="n">get_language_from_request</span>
<span class="kn">from</span> <span class="nn">cms.utils.i18n</span> <span class="kn">import</span> <span class="n">get_fallback_languages</span>
<span class="kn">from</span> <span class="nn">cms.utils.moderator</span> <span class="kn">import</span> <span class="n">get_page_queryset</span><span class="p">,</span> <span class="n">get_title_queryset</span>
<span class="kn">from</span> <span class="nn">cms.utils.plugins</span> <span class="kn">import</span> <span class="n">current_site</span>
<span class="kn">from</span> <span class="nn">menus.base</span> <span class="kn">import</span> <span class="n">Menu</span><span class="p">,</span> <span class="n">NavigationNode</span><span class="p">,</span> <span class="n">Modifier</span>
<span class="kn">from</span> <span class="nn">menus.menu_pool</span> <span class="kn">import</span> <span class="n">menu_pool</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="kn">import</span> <span class="n">Site</span>
<span class="kn">from</span> <span class="nn">django.db.models.query_utils</span> <span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">Permission</span>

<div class="viewcode-block" id="get_visible_pages"><a class="viewcode-back" href="../../auto_modules.html#cms.menu.get_visible_pages">[docs]</a><span class="k">def</span> <span class="nf">get_visible_pages</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">site</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     This code is basically a many-pages-at-once version of</span>
<span class="sd">     Page.has_view_permission.</span>
<span class="sd">     pages contains all published pages</span>
<span class="sd">     check if there is ANY restriction</span>
<span class="sd">     that needs a permission page visibility calculation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_setting_public_all</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">CMS_PUBLIC_FOR</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span>
    <span class="n">is_setting_public_staff</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">CMS_PUBLIC_FOR</span> <span class="o">==</span> <span class="s">&#39;staff&#39;</span>
    <span class="n">is_auth_user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span>
    
    <span class="n">visible_page_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">restricted_pages</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">pages_perms_q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
        <span class="c"># taken from for_page as multiple at once version</span>
        <span class="n">page_q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">page__tree_id</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">tree_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">)</span> 
            <span class="o">|</span> <span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">page__level__lt</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">grant_on</span><span class="o">=</span><span class="n">ACCESS_DESCENDANTS</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">grant_on</span><span class="o">=</span><span class="n">ACCESS_PAGE_AND_DESCENDANTS</span><span class="p">)))</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">page__level</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">grant_on</span><span class="o">=</span><span class="n">ACCESS_CHILDREN</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">grant_on</span><span class="o">=</span><span class="n">ACCESS_PAGE_AND_CHILDREN</span><span class="p">)))</span>  
        <span class="p">)</span> 
        <span class="n">pages_perms_q</span> <span class="o">|=</span> <span class="n">page_q</span>
        
        
    <span class="n">pages_perms_q</span> <span class="o">&amp;=</span> <span class="n">Q</span><span class="p">(</span><span class="n">can_view</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">page_permissions</span> <span class="o">=</span> <span class="n">PagePermission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pages_perms_q</span><span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="s">&#39;group__users&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">page_permissions</span><span class="p">:</span>
        <span class="c"># collect the pages that are affected by permissions</span>
        <span class="k">if</span> <span class="n">perm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">perm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restricted_pages</span><span class="p">[</span><span class="n">perm</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">pk</span><span class="p">]:</span>
            <span class="c"># affective restricted pages gathering</span>
            <span class="c"># using mptt functions </span>
            <span class="c"># add the page with the perm itself</span>
            <span class="k">if</span> <span class="n">perm</span><span class="o">.</span><span class="n">grant_on</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ACCESS_PAGE</span><span class="p">,</span> <span class="n">ACCESS_PAGE_AND_CHILDREN</span> <span class="p">,</span><span class="n">ACCESS_PAGE_AND_DESCENDANTS</span><span class="p">]:</span>
                <span class="n">restricted_pages</span><span class="p">[</span><span class="n">perm</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">pk</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
            <span class="c"># add children    </span>
            <span class="k">if</span> <span class="n">perm</span><span class="o">.</span><span class="n">grant_on</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ACCESS_CHILDREN</span><span class="p">,</span> <span class="n">ACCESS_PAGE_AND_CHILDREN</span><span class="p">]:</span> 
                <span class="n">child_ids</span> <span class="o">=</span> <span class="n">perm</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">child_ids</span><span class="p">:</span>
                    <span class="n">restricted_pages</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
            <span class="c"># add descendants</span>
            <span class="k">elif</span> <span class="n">perm</span><span class="o">.</span><span class="n">grant_on</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ACCESS_DESCENDANTS</span><span class="p">,</span> <span class="n">ACCESS_PAGE_AND_DESCENDANTS</span><span class="p">]:</span> 
                <span class="n">child_ids</span> <span class="o">=</span> <span class="n">perm</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">get_descendants</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">child_ids</span><span class="p">:</span>
                    <span class="n">restricted_pages</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
    <span class="c"># anonymous </span>
    <span class="c"># no restriction applied at all</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_auth_user</span> <span class="ow">and</span> 
        <span class="n">is_setting_public_all</span> <span class="ow">and</span> 
        <span class="ow">not</span> <span class="n">restricted_pages</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">page</span><span class="o">.</span><span class="n">pk</span> <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">]</span> 
    
   
    <span class="k">if</span> <span class="n">site</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">site</span> <span class="o">=</span> <span class="n">current_site</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    
    <span class="c"># authenticated user and global permission</span>
    <span class="k">if</span> <span class="n">is_auth_user</span><span class="p">:</span>
        <span class="n">global_page_perm_q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">group__user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">&amp;</span> <span class="n">Q</span><span class="p">(</span><span class="n">can_view</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Q</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">sites__in</span><span class="o">=</span><span class="p">[</span><span class="n">site</span><span class="o">.</span><span class="n">pk</span><span class="p">])</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">sites__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">global_view_perms</span> <span class="o">=</span> <span class="n">GlobalPagePermission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">global_page_perm_q</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
 
        <span class="c">#no page perms edgcase - all visible</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">is_setting_public_all</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">is_setting_public_staff</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span><span class="p">))</span><span class="ow">and</span> 
            <span class="ow">not</span> <span class="n">restricted_pages</span> <span class="ow">and</span>
            <span class="ow">not</span> <span class="n">global_view_perms</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">page</span><span class="o">.</span><span class="n">pk</span> <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">]</span>
        <span class="c">#no page perms edgcase - none visible</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">is_setting_public_staff</span> <span class="ow">and</span> 
            <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span> <span class="ow">and</span> 
            <span class="ow">not</span> <span class="n">restricted_pages</span> <span class="ow">and</span>
            <span class="ow">not</span> <span class="n">global_view_perms</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
           
        
    <span class="k">def</span> <span class="nf">has_global_perm</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">has_global_perm</span><span class="o">.</span><span class="n">cache</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">has_global_perm</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s">&#39;cms.view_page&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">has_global_perm</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span>
    <span class="n">has_global_perm</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">has_permission_membership</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PagePermission user group membership tests</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span>
        <span class="n">page_pk</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">pk</span>
        <span class="n">has_perm</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">restricted_pages</span><span class="p">[</span><span class="n">page_pk</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">perm</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_pk</span><span class="p">:</span>
                <span class="n">has_perm</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">perm</span><span class="o">.</span><span class="n">group_id</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">group_user_ids</span> <span class="o">=</span> <span class="n">perm</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">user_set</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;pk&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_pk</span> <span class="ow">in</span> <span class="n">group_user_ids</span><span class="p">:</span>
                <span class="n">has_perm</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">has_perm</span>
    
    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
        <span class="n">to_add</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c"># default to false, showing a restricted page is bad</span>
        <span class="c"># explicitly check all the conditions</span>
        <span class="c"># of settings and permissions</span>
        <span class="n">is_restricted</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">pk</span> <span class="ow">in</span> <span class="n">restricted_pages</span>
        <span class="c"># restricted_pages contains as key any page.pk that is </span>
        <span class="c"># affected by a permission grant_on</span>
        <span class="k">if</span> <span class="n">is_auth_user</span><span class="p">:</span>
            <span class="c"># a global permission was given to the request&#39;s user</span>
            <span class="k">if</span> <span class="n">global_view_perms</span><span class="p">:</span>
                <span class="n">to_add</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c"># setting based handling of unrestricted pages</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_restricted</span> <span class="ow">and</span> <span class="p">(</span>
                     <span class="n">is_setting_public_all</span> <span class="ow">or</span> <span class="p">(</span>
                       <span class="n">is_setting_public_staff</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span><span class="p">)</span>
                     <span class="p">):</span> 
                <span class="c"># authenticated user, no restriction and public for all</span>
                <span class="c"># or </span>
                <span class="c"># authenticated staff user, no restriction and public for staff</span>
                <span class="n">to_add</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c"># check group and user memberships to restricted pages</span>
            <span class="k">elif</span> <span class="n">is_restricted</span> <span class="ow">and</span> <span class="n">has_permission_membership</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
                <span class="n">to_add</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">has_global_perm</span><span class="p">():</span>
                <span class="n">to_add</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># anonymous user, no restriction  </span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_restricted</span> <span class="ow">and</span> <span class="n">is_setting_public_all</span><span class="p">:</span>
            <span class="n">to_add</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># store it</span>
        <span class="k">if</span> <span class="n">to_add</span><span class="p">:</span>
            <span class="n">visible_page_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">visible_page_ids</span>
</div>
<div class="viewcode-block" id="page_to_node"><a class="viewcode-back" href="../../auto_modules.html#cms.menu.page_to_node">[docs]</a><span class="k">def</span> <span class="nf">page_to_node</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">home</span><span class="p">,</span> <span class="n">cut</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Transform a CMS page into a navigation node.</span>
<span class="sd">    </span>
<span class="sd">    page: the page you wish to transform</span>
<span class="sd">    home: a reference to the &quot;home&quot; page (the page with tree_id=1)</span>
<span class="sd">    cut: Should we cut page from it&#39;s parent pages? This means the node will not</span>
<span class="sd">         have a parent anymore.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># Theses are simple to port over, since they are not calculated.</span>
    <span class="c"># Other attributes will be added conditionnally later.</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;soft_root&#39;</span><span class="p">:</span><span class="n">page</span><span class="o">.</span><span class="n">soft_root</span><span class="p">,</span>
            <span class="s">&#39;auth_required&#39;</span><span class="p">:</span><span class="n">page</span><span class="o">.</span><span class="n">login_required</span><span class="p">,</span>
            <span class="s">&#39;reverse_id&#39;</span><span class="p">:</span><span class="n">page</span><span class="o">.</span><span class="n">reverse_id</span><span class="p">,}</span>
    
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">parent_id</span>
    <span class="c"># Should we cut the Node from its parents?</span>
    <span class="k">if</span> <span class="n">home</span> <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">==</span> <span class="n">home</span><span class="o">.</span><span class="n">pk</span> <span class="ow">and</span> <span class="n">cut</span><span class="p">:</span>
        <span class="n">parent_id</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="c"># possible fix for a possible problem</span>
    <span class="c">#if parent_id and not page.parent.get_calculated_status():</span>
    <span class="c">#    parent_id = None # ????</span>
    
    <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">limit_visibility_in_menu</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">attr</span><span class="p">[</span><span class="s">&#39;visible_for_authenticated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">attr</span><span class="p">[</span><span class="s">&#39;visible_for_anonymous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">attr</span><span class="p">[</span><span class="s">&#39;visible_for_authenticated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">limit_visibility_in_menu</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">attr</span><span class="p">[</span><span class="s">&#39;visible_for_anonymous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">limit_visibility_in_menu</span> <span class="o">==</span> <span class="mi">2</span>
        
    <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">home</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
        <span class="n">attr</span><span class="p">[</span><span class="s">&#39;is_home&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># Extenders can be either navigation extenders or from apphooks.</span>
    <span class="n">extenders</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">navigation_extenders</span><span class="p">:</span>
        <span class="n">extenders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">navigation_extenders</span><span class="p">)</span>
    <span class="c"># Is this page an apphook? If so, we need to handle the apphooks&#39;s nodes</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">app_name</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_application_urls</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Title</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">app_name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">app_name</span><span class="p">:</span> <span class="c"># it means it is an apphook</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">apphook_pool</span><span class="o">.</span><span class="n">get_apphook</span><span class="p">(</span><span class="n">app_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">menu</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">menus</span><span class="p">:</span>
            <span class="n">extenders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">menu</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">extenders</span><span class="p">:</span>
        <span class="n">attr</span><span class="p">[</span><span class="s">&#39;navigation_extenders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extenders</span>
    
    <span class="c"># Do we have a redirectURL?</span>
    <span class="n">attr</span><span class="p">[</span><span class="s">&#39;redirect_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_redirect</span><span class="p">()</span>  <span class="c"># save redirect URL if any</span>
    
    <span class="c"># Now finally, build the NavigationNode object and return it.</span>
    <span class="n">ret_node</span> <span class="o">=</span> <span class="n">NavigationNode</span><span class="p">(</span>
        <span class="n">page</span><span class="o">.</span><span class="n">get_menu_title</span><span class="p">(),</span> 
        <span class="n">page</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">(),</span> 
        <span class="n">page</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> 
        <span class="n">parent_id</span><span class="p">,</span> 
        <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span>
        <span class="n">visible</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">in_navigation</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ret_node</span>
</div>
<div class="viewcode-block" id="CMSMenu"><a class="viewcode-back" href="../../auto_modules.html#cms.menu.CMSMenu">[docs]</a><span class="k">class</span> <span class="nc">CMSMenu</span><span class="p">(</span><span class="n">Menu</span><span class="p">):</span>
    
<div class="viewcode-block" id="CMSMenu.get_nodes"><a class="viewcode-back" href="../../auto_modules.html#cms.menu.CMSMenu.get_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">get_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">page_queryset</span> <span class="o">=</span> <span class="n">get_page_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">site</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_current</span><span class="p">()</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">get_language_from_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        
        <span class="n">filters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;site&#39;</span><span class="p">:</span><span class="n">site</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">CMS_HIDE_UNTRANSLATED</span><span class="p">:</span>
            <span class="n">filters</span><span class="p">[</span><span class="s">&#39;title_set__language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lang</span>
            
        <span class="n">pages</span> <span class="o">=</span> <span class="n">page_queryset</span><span class="o">.</span><span class="n">published</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">filters</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&quot;tree_id&quot;</span><span class="p">,</span> <span class="s">&quot;lft&quot;</span><span class="p">)</span>
        
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">first</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">home_cut</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">home_children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">home</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">actual_pages</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c"># cache view perms</span>
        <span class="n">visible_pages</span> <span class="o">=</span> <span class="n">get_visible_pages</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">site</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
            <span class="c"># Pages are ordered by tree_id, therefore the first page is the root</span>
            <span class="c"># of the page tree (a.k.a &quot;home&quot;)</span>
            <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">pk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visible_pages</span><span class="p">:</span>
                <span class="c"># Don&#39;t include pages the user doesn&#39;t have access to</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">home</span><span class="p">:</span>
                <span class="n">home</span> <span class="o">=</span> <span class="n">page</span>
            <span class="n">page</span><span class="o">.</span><span class="n">home_pk_cache</span> <span class="o">=</span> <span class="n">home</span><span class="o">.</span><span class="n">pk</span>
            <span class="k">if</span> <span class="n">first</span> <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">pk</span> <span class="o">!=</span> <span class="n">home</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                <span class="n">home_cut</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">==</span> <span class="n">home</span><span class="o">.</span><span class="n">pk</span> <span class="ow">or</span> <span class="n">page</span><span class="o">.</span><span class="n">parent_id</span> <span class="ow">in</span> <span class="n">home_children</span><span class="p">)</span> <span class="ow">and</span> <span class="n">home_cut</span><span class="p">:</span>
                <span class="n">home_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">home</span><span class="o">.</span><span class="n">pk</span> <span class="ow">and</span> <span class="n">home</span><span class="o">.</span><span class="n">in_navigation</span><span class="p">)</span> <span class="ow">or</span> <span class="n">page</span><span class="o">.</span><span class="n">pk</span> <span class="o">!=</span> <span class="n">home</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">actual_pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

        <span class="n">titles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_title_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">page__in</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="n">lang</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">actual_pages</span><span class="p">:</span> <span class="c"># add the title and slugs and some meta data</span>
            <span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">titles</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">title</span><span class="o">.</span><span class="n">page_id</span> <span class="o">==</span> <span class="n">page</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;title_cache&quot;</span><span class="p">):</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">title_cache</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">title_cache</span><span class="p">[</span><span class="n">title</span><span class="o">.</span><span class="n">language</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
                    <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page_to_node</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">home</span><span class="p">,</span> <span class="n">home_cut</span><span class="p">))</span>
                    <span class="n">ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ids</span><span class="p">:</span> <span class="c"># get fallback languages</span>
            <span class="n">fallbacks</span> <span class="o">=</span> <span class="n">get_fallback_languages</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">fallbacks</span><span class="p">:</span>
                <span class="n">titles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_title_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">page__in</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="n">lang</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">titles</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">actual_pages</span><span class="p">:</span> <span class="c"># add the title and slugs and some meta data</span>
                        <span class="k">if</span> <span class="n">title</span><span class="o">.</span><span class="n">page_id</span> <span class="o">==</span> <span class="n">page</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;title_cache&quot;</span><span class="p">):</span>
                                <span class="n">page</span><span class="o">.</span><span class="n">title_cache</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">page</span><span class="o">.</span><span class="n">title_cache</span><span class="p">[</span><span class="n">title</span><span class="o">.</span><span class="n">language</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
                            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page_to_node</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">home</span><span class="p">,</span> <span class="n">home_cut</span><span class="p">))</span>
                            <span class="n">ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">nodes</span>  </div></div>
<span class="n">menu_pool</span><span class="o">.</span><span class="n">register_menu</span><span class="p">(</span><span class="n">CMSMenu</span><span class="p">)</span>

<div class="viewcode-block" id="NavExtender"><a class="viewcode-back" href="../../auto_modules.html#cms.menu.NavExtender">[docs]</a><span class="k">class</span> <span class="nc">NavExtender</span><span class="p">(</span><span class="n">Modifier</span><span class="p">):</span>
<div class="viewcode-block" id="NavExtender.modify"><a class="viewcode-back" href="../../auto_modules.html#cms.menu.NavExtender.modify">[docs]</a>    <span class="k">def</span> <span class="nf">modify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">root_id</span><span class="p">,</span> <span class="n">post_cut</span><span class="p">,</span> <span class="n">breadcrumb</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">post_cut</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nodes</span>
        <span class="n">exts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># rearrange the parent relations</span>
        <span class="n">home</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;is_home&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                <span class="n">home</span> <span class="o">=</span> <span class="n">node</span>
            <span class="n">extenders</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;navigation_extenders&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extenders</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">extenders</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">exts</span><span class="p">:</span>
                        <span class="n">exts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">extnode</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">extnode</span><span class="o">.</span><span class="n">namespace</span> <span class="o">==</span> <span class="n">ext</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">extnode</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span><span class="c"># if home has nav extenders but home is not visible</span>
                            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;is_home&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">visible</span><span class="p">:</span>
                                <span class="n">extnode</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">=</span> <span class="bp">None</span>
                                <span class="n">extnode</span><span class="o">.</span><span class="n">parent_namespace</span> <span class="o">=</span> <span class="bp">None</span>
                                <span class="n">extnode</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">None</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">extnode</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span>
                                <span class="n">extnode</span><span class="o">.</span><span class="n">parent_namespace</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">namespace</span>
                                <span class="n">extnode</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">node</span>
                                <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extnode</span><span class="p">)</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># find all not assigned nodes</span>
        <span class="k">for</span> <span class="n">menu</span> <span class="ow">in</span> <span class="n">menu_pool</span><span class="o">.</span><span class="n">menus</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">menu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;cms_enabled&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">menu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cms_enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">menu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">exts</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">namespace</span> <span class="o">==</span> <span class="n">menu</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">removed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">breadcrumb</span><span class="p">:</span>  
            <span class="c"># if breadcrumb and home not in navigation add node</span>
            <span class="k">if</span> <span class="n">breadcrumb</span> <span class="ow">and</span> <span class="n">home</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">home</span><span class="o">.</span><span class="n">visible</span><span class="p">:</span>
                <span class="n">home</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="n">home</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">():</span>
                    <span class="n">home</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">home</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c"># remove all nodes that are nav_extenders and not assigned </span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">removed</span><span class="p">:</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nodes</span>   </div></div>
<span class="n">menu_pool</span><span class="o">.</span><span class="n">register_modifier</span><span class="p">(</span><span class="n">NavExtender</span><span class="p">)</span>


<div class="viewcode-block" id="SoftRootCutter"><a class="viewcode-back" href="../../auto_modules.html#cms.menu.SoftRootCutter">[docs]</a><span class="k">class</span> <span class="nc">SoftRootCutter</span><span class="p">(</span><span class="n">Modifier</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ask evildmp/superdmp if you don&#39;t understand softroots!</span>
<span class="sd">    </span>
<span class="sd">    Softroot description from the docs:</span>
<span class="sd">    </span>
<span class="sd">        A soft root is a page that acts as the root for a menu navigation tree.</span>
<span class="sd">    </span>
<span class="sd">        Typically, this will be a page that is the root of a significant new</span>
<span class="sd">        section on your site.</span>
<span class="sd">    </span>
<span class="sd">        When the soft root feature is enabled, the navigation menu for any page</span>
<span class="sd">        will start at the nearest soft root, rather than at the real root of</span>
<span class="sd">        the site’s page hierarchy.</span>
<span class="sd">    </span>
<span class="sd">        This feature is useful when your site has deep page hierarchies (and</span>
<span class="sd">        therefore multiple levels in its navigation trees). In such a case, you</span>
<span class="sd">        usually don’t want to present site visitors with deep menus of nested</span>
<span class="sd">        items.</span>
<span class="sd">    </span>
<span class="sd">        For example, you’re on the page -Introduction to Bleeding-?, so the menu</span>
<span class="sd">        might look like this:</span>
<span class="sd">    </span>
<span class="sd">            School of Medicine</span>
<span class="sd">                Medical Education</span>
<span class="sd">                Departments</span>
<span class="sd">                    Department of Lorem Ipsum</span>
<span class="sd">                    Department of Donec Imperdiet</span>
<span class="sd">                    Department of Cras Eros</span>
<span class="sd">                    Department of Mediaeval Surgery</span>
<span class="sd">                        Theory</span>
<span class="sd">                        Cures</span>
<span class="sd">                        Bleeding</span>
<span class="sd">                            Introduction to Bleeding &lt;this is the current page&gt;</span>
<span class="sd">                            Bleeding - the scientific evidence</span>
<span class="sd">                            Cleaning up the mess</span>
<span class="sd">                            Cupping</span>
<span class="sd">                            Leaches</span>
<span class="sd">                            Maggots</span>
<span class="sd">                        Techniques</span>
<span class="sd">                        Instruments</span>
<span class="sd">                    Department of Curabitur a Purus</span>
<span class="sd">                    Department of Sed Accumsan</span>
<span class="sd">                    Department of Etiam</span>
<span class="sd">                Research</span>
<span class="sd">                Administration</span>
<span class="sd">                Contact us</span>
<span class="sd">                Impressum</span>
<span class="sd">    </span>
<span class="sd">        which is frankly overwhelming.</span>
<span class="sd">    </span>
<span class="sd">        By making -Department of Mediaeval Surgery-? a soft root, the menu</span>
<span class="sd">        becomes much more manageable:</span>
<span class="sd">    </span>
<span class="sd">            Department of Mediaeval Surgery</span>
<span class="sd">                Theory</span>
<span class="sd">                Cures</span>
<span class="sd">                    Bleeding</span>
<span class="sd">                        Introduction to Bleeding &lt;current page&gt;</span>
<span class="sd">                        Bleeding - the scientific evidence</span>
<span class="sd">                        Cleaning up the mess</span>
<span class="sd">                    Cupping</span>
<span class="sd">                    Leaches</span>
<span class="sd">                    Maggots</span>
<span class="sd">                Techniques</span>
<span class="sd">                Instruments</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SoftRootCutter.modify"><a class="viewcode-back" href="../../auto_modules.html#cms.menu.SoftRootCutter.modify">[docs]</a>    <span class="k">def</span> <span class="nf">modify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">root_id</span><span class="p">,</span> <span class="n">post_cut</span><span class="p">,</span> <span class="n">breadcrumb</span><span class="p">):</span>
        <span class="c"># only apply this modifier if we&#39;re pre-cut (since what we do is cut)</span>
        <span class="k">if</span> <span class="n">post_cut</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">CMS_SOFTROOT</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nodes</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">root_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># find the selected node as well as all the root nodes</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="n">node</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
                <span class="n">root_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        
        <span class="c"># if we found a selected ...</span>
        <span class="k">if</span> <span class="n">selected</span><span class="p">:</span>
            <span class="c"># and the selected is a softroot</span>
            <span class="k">if</span> <span class="n">selected</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;soft_root&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                <span class="c"># get it&#39;s descendants</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="n">selected</span><span class="o">.</span><span class="n">get_descendants</span><span class="p">()</span>
                <span class="c"># remove the link to parent</span>
                <span class="n">selected</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="c"># make the selected page the root in the menu</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">selected</span><span class="p">]</span> <span class="o">+</span> <span class="n">nodes</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># if it&#39;s not a soft root, walk ancestors (upwards!)</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_ancestors_and_remove_children</span><span class="p">(</span><span class="n">selected</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nodes</span>
    </div>
<div class="viewcode-block" id="SoftRootCutter.find_and_remove_children"><a class="viewcode-back" href="../../auto_modules.html#cms.menu.SoftRootCutter.find_and_remove_children">[docs]</a>    <span class="k">def</span> <span class="nf">find_and_remove_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;soft_root&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_children</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nodes</span>
    </div>
<div class="viewcode-block" id="SoftRootCutter.remove_children"><a class="viewcode-back" href="../../auto_modules.html#cms.menu.SoftRootCutter.remove_children">[docs]</a>    <span class="k">def</span> <span class="nf">remove_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_children</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
    </div>
<div class="viewcode-block" id="SoftRootCutter.find_ancestors_and_remove_children"><a class="viewcode-back" href="../../auto_modules.html#cms.menu.SoftRootCutter.find_ancestors_and_remove_children">[docs]</a>    <span class="k">def</span> <span class="nf">find_ancestors_and_remove_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check ancestors of node for soft roots</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;soft_root&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_descendants</span><span class="p">()</span>
                <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span> <span class="o">+</span> <span class="n">nodes</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_ancestors_and_remove_children</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">newnode</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">newnode</span> <span class="o">!=</span> <span class="n">node</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">newnode</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">find_and_remove_children</span><span class="p">(</span><span class="n">newnode</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span> <span class="o">!=</span> <span class="n">node</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">find_and_remove_children</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nodes</span>
    </div></div>
<span class="n">menu_pool</span><span class="o">.</span><span class="n">register_modifier</span><span class="p">(</span><span class="n">SoftRootCutter</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">obp 0.0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, jonas ohrstrom.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>